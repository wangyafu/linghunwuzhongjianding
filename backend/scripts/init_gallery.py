"""å›¾åº“æ‰¹é‡åˆå§‹åŒ–è„šæœ¬"""
import asyncio
import os
import sys
import json
import time

# å°† backend ç›®å½•åŠ å…¥ sys.path ä»¥ä¾¿å¯¼å…¥ services
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from services.image_gen import generate_species_image,generate_species_image_from_prompt
from services.qiniu_storage import save_to_qiniu
STYLE_SUFFIX="æç®€æ¶‚é¸¦é£æ ¼ã€‚ç”»é£æ½¦è‰ï¼Œç”šè‡³æœ‰ç‚¹ä¸‘ã€‚èƒŒæ™¯é¢œè‰²å¿…é¡»æ˜¯çº¯ç™½çš„ã€‚"
# å¾…ç”Ÿæˆç‰©ç§åˆ—è¡¨ï¼š(ç‰©ç§åç§°, å›¾ç‰‡æè¿°åç¼€)
SPECIES_LIST = [
    ("çµé­‚å·²ç¦»èŒçš„å—å–½", "ä¸€åªç”»é£æ½¦è‰çš„çŒ´å­ï¼Œç©¿ç€ä¸åˆèº«çš„è¥¿è£…ï¼Œçœ¼è¢‹æ‰åˆ°ä¸‹å·´ï¼Œæ‰‹é‡Œæ‹¿ç€å·¨å¤§çš„å†°ç¾å¼ï¼Œçœ¼ç¥ç›´å‹¾å‹¾ä¸”ç©ºæ´" + STYLE_SUFFIX),
    ("ä¸»æ‰“å˜´ç¡¬çš„é¸­å­", "ä¸€åªè¢«çƒ¤ç†Ÿçš„ç„¦é»„é¸­å­èººåœ¨ç›˜å­é‡Œï¼Œä½†é•¿ç€ä¸€å¼ å·¨å¤§çš„ã€é—ªç€é‡‘å±å…‰æ³½çš„é’¢é“é¸­å˜´ï¼Œè¡¨æƒ…ä¸å±‘åœ°çœ‹ç€ä¸Šæ–¹" + STYLE_SUFFIX),
    ("æ…ˆçœ‰å–„ç›®åƒåœ¾æ¡¶", "ä¸€ä¸ªç»¿è‰²çš„è¡—è¾¹åƒåœ¾æ¡¶ï¼Œç›–å­å¼ å¼€åƒå¤§å˜´ï¼Œé•¿ç€ä¸€åŒæ…ˆçˆ±çš„çœ¼ç›ï¼Œèº«ä¸Šè´´ç€å°å¹¿å‘Šï¼Œç¥åœ£åˆç ´æ—§" + STYLE_SUFFIX),
    ("æˆ˜æŸç‰ˆæ‰‹æœºè†œ", "ä¸€å¼ å¸ƒæ»¡èœ˜è››ç½‘è£‚ç—•çš„é•¿æ–¹å½¢ç»ç’ƒè†œï¼Œè£‚ç—•ç»„æˆäº†ä¸€å¼ å“­æ³£çš„è„¸ï¼Œè™½ç„¶ç¢è£‚ä½†ä¾ç„¶åšå¼ºåœ°è´´åˆåœ¨ä¸€èµ·" + STYLE_SUFFIX),
    ("ç„¦è™‘åˆ°æ‰“ç»“çš„ç¼“å†²", "ä¸€ä¸ªåœ†å½¢çš„è¿›åº¦æ¡ï¼Œæœ«ç«¯æ‰“ç»“æˆä¸€å›¢ä¹±ç³Ÿç³Ÿçš„æ¯›çº¿ï¼Œæ¯›çº¿å›¢é•¿ç€ç„¦è™‘çš„è±†è±†çœ¼ï¼Œæ­£åœ¨æµæ±—" + STYLE_SUFFIX),
    ("ä¸€ç¢°å°±ç‚¸æ¯›ä»™äººçƒ", "ä¸€ç›†åœ†æ»šæ»šçš„ä»™äººæŒï¼Œåˆºå¤¸å¼ åœ°ç‚¸å¼€ï¼Œè„¸ä¸ŠæŒ‚ç€å€’å…«å­—çœ‰çš„æ„¤æ€’è¡¨æƒ…ï¼Œåˆºä¸‹éšçº¦è—ç€ä¸€æœµç²‰è‰²å°èŠ±" + STYLE_SUFFIX),
    ("è§’è½çš„å®¡åˆ¤ä¹‹çœ¼", "ä¸€ä¸ªå¢™è§’çš„ç™½è‰²ç›‘æ§æ¢å¤´ï¼Œé•œå¤´æ˜¯ä¸€åªå·¨å¤§çš„ã€åŠçœ¯ç€çš„çœŸäººçœ¼ç›ï¼Œçœ¼ç¥å‡‰è–„ä¸”è®¥ç¬‘" + STYLE_SUFFIX),
    ("å´©æºƒè¾¹ç¼˜çš„çš®ç­‹", "ä¸€æ ¹è¢«æ‹‰æ‰¯åˆ°æç»†çš„çº¢è‰²æ©¡çš®ç­‹ï¼Œä¸­é—´çº¤ç»´æ–­è£‚æ‘‡æ‘‡æ¬²å ï¼Œçš®ç­‹æ­£åœ¨å‘æŠ–å¹¶å°–å«" + STYLE_SUFFIX),
    ("å®‰è¯¦çš„é™ˆå¹´å’¸é±¼", "ä¸€æ¡ç°ç™½åƒµç¡¬çš„å¹²é±¼ç›´æŒºæŒºèººç€ï¼Œçœ¼ç›æ˜¯æ­»é±¼çœ¼X_Xï¼Œå¯¹ç€å‘¨å›´çš„ç«ç¾ä¿æŒå®‰è¯¦" + STYLE_SUFFIX),
    ("å“­æˆä¸€æ»©çš„æ£‰èŠ±ç³–", "ä¸€å›¢é£˜åœ¨ç©ºä¸­çš„ç™½è‰²ç‰©ä½“ï¼Œå½¢çŠ¶åƒèåŒ–ä¸”å§”å±ˆçš„è„¸ï¼Œæ­£åœ¨å¾€ä¸‹æ»´ç³–æ°´çœ¼æ³ªï¼Œèº«ä½“è¾¹ç¼˜å¡Œé™·" + STYLE_SUFFIX),
    ("æ™’å¤ªé˜³çš„çŸ³å¤´", "ä¸€å—ç°è‰²åœ†æ¶¦çš„å¤§çŸ³å¤´èººåœ¨è‰åœ°ä¸Šæ™’å¤ªé˜³ï¼Œè„¸ä¸ŠæŒ‚ç€ç®€ç¬”ç”»å¾®ç¬‘:)ï¼Œå¤´é¡¶åœç€ä¸€åªå°é¸Ÿï¼Œæ•£å‘ç€æè‡´çš„æ¾å¼›æ„Ÿ" + STYLE_SUFFIX),
    ("æ— è®ºå¦‚ä½•éƒ½ä¼šå¼€èŠ±çš„æ‚è‰", "ä¸€æœµä»æ°´æ³¥è£‚ç¼é‡Œé’»å‡ºçš„é»„è‰²è’²å…¬è‹±ï¼ŒèŒå¼¯æ›²ä½†èŠ±æœµè“¬æ¾å·¨å¤§ï¼Œé•¿ç€å…ƒæ°”æ»¡æ»¡çš„å¤§çœ¼ç›ï¼Œå¯¹ç€å¤ªé˜³æ¯”è€¶" + STYLE_SUFFIX),
    ("åˆšå¥½å……è¿›å»ç”µçš„æ’å¤´", "ä¸€ä¸ªæ’åœ¨æ’åº§ä¸Šçš„ç™½è‰²å……ç”µå¤´ï¼Œè¿æ¥çº¿æœ‰ç»¿è‰²é—ªç”µå‘å…‰ï¼Œè„¸ä¸Šæ˜¯çˆ½åˆ°äº†çš„æ˜Ÿæ˜Ÿçœ¼è¡¨æƒ…ï¼Œå‘¨å›´æœ‰æ´»åŠ›å°ç«èŠ±" + STYLE_SUFFIX),
    ("æ‹’ç»å†…è€—çš„ä¸ç²˜é”…", "ä¸€ä¸ªæˆ´ç€å¢¨é•œçš„é…·é…·é»‘è‰²å¹³åº•é”…ï¼Œä¸€ä¸ªä»£è¡¨ç„¦è™‘çš„é»‘ç…è›‹æ­£é¡ºæ»‘åœ°æ»‘èµ°ï¼Œå®Œå…¨ä¸ç²˜ï¼Œè¡¨æƒ…è‡ªä¿¡" + STYLE_SUFFIX),
    ("åˆšå‡ºç‚‰çš„è èåŒ…", "ä¸€ä¸ªé‡‘é»„é…¥è„†çš„è èåŒ…æ­£åœ¨å†’çƒ­æ°”ï¼Œèº«ä½“å› ä¸ºå¤ªè½¯è€Œå¡Œé™·ï¼Œæœ‰ä¸¤å›¢çº¢è„¸è›‹ï¼Œè¡¨æƒ…å®³ç¾ä¸”æ¸©æš–" + STYLE_SUFFIX),
    ("æˆ˜æŸç‰ˆå¿«é€’çº¸ç®±", "ä¸€ä¸ªç ´çƒ‚çš„ã€è¢«å‹æ‰çš„æ£•è‰²å¿«é€’çº¸ç®±ï¼Œæç®€æ¶‚é¸¦é£æ ¼ï¼Œçº¸ç®±ä¸Šæœ‰ä¸¤åªç”»ä¸Šå»çš„é»‘çœ¼åœˆå¾ˆé‡çš„çœ¼ç›ï¼Œçœ¼ç¥ç©ºæ´ï¼Œå˜´è§’å‘ä¸‹ï¼Œè´´ç€å‡Œä¹±çš„èƒ¶å¸¦ï¼Œå­¤é›¶é›¶åœ°èººåœ¨ç™½è‰²çš„åœ°ä¸Š" + STYLE_SUFFIX),
    ("èåŒ–äº†ä¸€åŠçš„é›ªç³•", "ä¸€å¨æ­£åœ¨èåŒ–çš„ç™½è‰²é›ªç³•ï¼Œåƒä¸€æ»©æ¶²ä½“ä¸€æ ·æ‘Šå¹³åœ¨åœ°ä¸Šï¼Œæç®€æ’ç”»é£æ ¼ã€‚è™½ç„¶èº«ä½“èåŒ–äº†ï¼Œä½†è„¸ä¸ŠæŒ‚ç€æå…¶å®‰è¯¦ã€ä½›ç³»çš„å¾®ç¬‘ï¼ˆè±†è±†çœ¼ï¼Œå¾®ç¬‘å˜´ï¼‰ï¼Œä»¿ä½›çœ‹é€äº†çº¢å°˜ã€‚ç”»é£å¯çˆ±ä½†é¢“åºŸï¼Œè½¯ç³¯æ„Ÿ" + STYLE_SUFFIX)
]
PRESET_FILE = os.path.join(os.path.dirname(os.path.dirname(__file__)), "data", "preset_species.json")


async def process_species(name: str, desc: str):
    """å¤„ç†å•ä¸ªç‰©ç§ï¼šç”Ÿæˆ -> ä¸Šä¼  -> è¿”å›æ•°æ®"""
    print(f"ğŸ”„ Processing: {name}...")
    try:
        # 1. ç”Ÿæˆå›¾ç‰‡
        temp_url = await generate_species_image_from_prompt(desc)
        print(f"  Canvas generated: {temp_url[:50]}...")
        
        # 2. ä¸Šä¼ ä¸ƒç‰›äº‘
        timestamp = int(time.time())
        name_safe = name.replace(" ", "_")
        key = f"species/{name_safe}_{timestamp}.png"
        
        final_url = await save_to_qiniu(temp_url, key)
        print(f"  Upload success: {final_url}")
        
        return {
            "object_name": name,
            "image_url": final_url
        }
    except Exception as e:
        print(f"âŒ Failed to process {name}: {e}")
        return None


async def main():
    print("ğŸš€ Starting Batch Generation...")
    
    # è¯»å–ç°æœ‰æ•°æ®ï¼ˆé¿å…è¦†ç›–æœªä¿®æ”¹çš„ï¼‰
    existing_data = []
    if os.path.exists(PRESET_FILE):
        try:
            with open(PRESET_FILE, "r", encoding="utf-8") as f:
                existing_data = json.load(f)
        except:
            pass
    
    # è½¬æ¢ä¸ºå­—å…¸æ–¹ä¾¿æ›´æ–°
    data_map = {item["object_name"]: item for item in existing_data}
    
    results = []
    # å¹¶å‘å¤„ç†ï¼ˆæˆ–è€…ä¸ºäº†ç¨³å¦¥èµ·è§ï¼Œä¸²è¡Œå¤„ç†é¿å… API é™æµï¼‰
    # è¿™é‡Œé€‰æ‹©ä¸²è¡Œï¼Œç¨³ä¸€ç‚¹
    for name, desc in SPECIES_LIST:
        # å¦‚æœå·²ç»å­˜åœ¨ä¸”æœ‰æœ‰æ•ˆé“¾æ¥ï¼ˆé exampleï¼‰ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©è·³è¿‡
        # if name in data_map and "example.com" not in data_map[name]["image_url"]:
        #    print(f"â© Skipping {name} (already exists)")
        #    continue
            
        item = await process_species(name, desc)
        if item:
            data_map[name] = item
            # å®æ—¶ä¿å­˜ï¼Œé˜²æ­¢ä¸­æ–­
            with open(PRESET_FILE, "w", encoding="utf-8") as f:
                json.dump(list(data_map.values()), f, ensure_ascii=False, indent=2)
            
            # ç¤¼è²Œæ€§å»¶è¿Ÿï¼Œé¿å… QPS è¿‡é«˜
            time.sleep(1)

    print("\nâœ… All done! Preset species updated.")


if __name__ == "__main__":
    asyncio.run(main())
